name: CI

# Trigger this workflow manually via GitHub Actions UI
on:
  push:
    branches: [main, test]
  pull_request:
    branches: [main]

jobs:
  # First job: Retrieve the latest download URL for Tabular Editor 2.x
  Get_download_URL_for_Tabular_Editor:
    runs-on: ubuntu-latest
    outputs:
      download_url: ${{ steps.get_url.outputs.DOWNLOAD_URL }}

    steps:
      - name: Try to open the URL and extract the download link
        id: get_url
        run: |
          # URL of the latest release page
          url="https://github.com/TabularEditor/TabularEditor/releases/latest"
          
          # Follow redirects to get the effective release URL
          response_url=$(curl -Ls -o /dev/null -w %{url_effective} $url || echo "failed")
          
          if [ "$response_url" = "failed" ]; then
            echo "Failed to get the response URL."
            exit 1
          else
            echo "Response URL: $response_url"
            
            # Extract version number from URL (e.g., tag/2.25.0)
            if [[ $response_url =~ tag\/([0-9]+\.[0-9]+(\.[0-9]+)?) ]]; then
              version="${BASH_REMATCH[1]}"
              
              # Normalize version format if necessary (e.g., 2.25 ‚Üí 2.25.0)
              if [[ $version =~ ^[0-9]+\.[0-9]+$ ]]; then
                version="${version}.0"
              fi
              
              echo "Extracted version: $version"
              
              # Construct the direct download link
              download_url="https://cdn.tabulareditor.com/files/TabularEditor.${version}.zip"
              echo "Download URL: $download_url"
              
              # Make the download URL available to downstream jobs
              echo "DOWNLOAD_URL=$download_url" >> $GITHUB_OUTPUT
            else
              echo "Failed to extract the version number from the response URL."
              exit 1
            fi
          fi
        shell: bash

  # Second job: Download, extract and run Tabular Editor with BPA
  Install_TabularEditor_and_run_BPA:
    needs: Get_download_URL_for_Tabular_Editor
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3  # Ensures source code is available

      - name: Install Tabular Editor
        run: |
          curl -L ${{ needs.Get_download_URL_for_Tabular_Editor.outputs.download_url }} -o TabularEditor.zip
          unzip TabularEditor.zip
                 
      - name: Run Tabular Editor and the BPA against your semantic model
        run: |
          ./TabularEditor.exe "CCDP.SemanticModel/definition/database.tmdl" -A "BPARules.json" `
          | Tee-Object -FilePath "./BPA_output.txt" 
        shell: pwsh
          
      - name: Check BPA severity levels and fail only on severity 3
        run: |
          Write-Host "üîç Checking BPA output for rule severities..."
          $content = Get-Content "./BPA_output.txt"

          # Find all Severity 3, 2, and 1 rule blocks with context (same display style as your BPA output)
          $severity3 = $content | Select-String -Pattern "Severity\s*3" -Context 4,4
          $severity2 = $content | Select-String -Pattern "Severity\s*2" -Context 4,4
          $severity1 = $content | Select-String -Pattern "Severity\s*1" -Context 4,4

          if ($severity3) {
            Write-Host ""
            Write-Host "‚ùå Found Severity 3 rule violations (these will fail the pipeline):"
            Write-Host "==============================================================="
            $severity3 | ForEach-Object {
              Write-Host "---------------------------------------------------------------"
              $_.Context.PreContext | ForEach-Object { Write-Host $_ }
              Write-Host $_.Line
              $_.Context.PostContext | ForEach-Object { Write-Host $_ }
            }
            exit 1
          } else {
            Write-Host "‚úÖ No Severity 3 rule violations found."
          }

          if ($severity2) {
            Write-Warning "‚ö†Ô∏è Severity 2 warnings detected (non-blocking):"
            $severity2 | ForEach-Object {
              Write-Host "---------------------------------------------------------------"
              $_.Context.PreContext | ForEach-Object { Write-Host $_ }
              Write-Host $_.Line
              $_.Context.PostContext | ForEach-Object { Write-Host $_ }
            }
          }

          if ($severity1) {
            Write-Warning "‚ÑπÔ∏è Severity 1 informational messages detected:"
            $severity1 | ForEach-Object {
              Write-Host "---------------------------------------------------------------"
              $_.Context.PreContext | ForEach-Object { Write-Host $_ }
              Write-Host $_.Line
              $_.Context.PostContext | ForEach-Object { Write-Host $_ }
            }
          }

          Write-Host "BPA rule scan complete."
        shell: pwsh
          
      - name: Upload BPA result into a .txt file
        uses: actions/upload-artifact@v4
        with:
          name: BPA_Result
          path: ./BPA_output.txt
          if-no-files-found: error