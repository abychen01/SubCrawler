name: Power BI Fabric CI/CD

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  FABRIC_API_URL: https://api.fabric.microsoft.com

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: >
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": ""
            }
          auth-type: SERVICE_PRINCIPAL
          allow-no-subscriptions: true

      - name: Get Fabric Access Token
        id: get-token
        run: |
          FABRIC_TOKEN=$(az account get-access-token --resource "${{ env.FABRIC_API_URL }}" --query accessToken -o tsv)
          echo "FABRIC_TOKEN=$FABRIC_TOKEN" >> $GITHUB_ENV

      - name: Validate DIVIDE usage in measures
        run: |
          echo "Checking for '/' in DAX measures..."
          INVALID_MEASURES=$(grep -rPo '"Expression"\s*:\s*"\K[^"]+' yourfile.pbip/Model | grep '/')
          if [ ! -z "$INVALID_MEASURES" ]; then
            echo "Error: Found measures using '/' instead of DIVIDE():"
            echo "$INVALID_MEASURES"
            exit 1
          fi
          echo "All measures use DIVIDE() correctly."

      - name: Publish PBIP to Fabric Workspace
        env:
          WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
          FABRIC_TOKEN: ${{ env.FABRIC_TOKEN }}
        run: |
          echo "Publishing .pbip file to Fabric..."
          zip -r pbip_package.zip yourfile.pbip
          curl -X POST \
            "${{ env.FABRIC_API_URL }}/v1/workspaces/$WORKSPACE_ID/files" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -F "file=@pbip_package.zip" \
            -F "overwrite=true"
