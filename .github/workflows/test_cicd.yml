name: Power BI Fabric CI/CD

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  FABRIC_API_URL: https://api.fabric.microsoft.com

permissions:
  id-token: write
  contents: read

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: >
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": ""
            }
          auth-type: SERVICE_PRINCIPAL
          allow-no-subscriptions: true

      - name: Get Fabric Access Token
        id: get-token
        run: |
          echo "üîê Fetching Fabric access token..."
          FABRIC_TOKEN=$(az account get-access-token --resource "${{ env.FABRIC_API_URL }}" --query accessToken -o tsv)
          echo "FABRIC_TOKEN=$FABRIC_TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Token retrieved."

      - name: Debug Repository Structure
        run: |
          echo "üìÇ Listing repository structure (for debug)..."
          ls -R

      - name: Validate DIVIDE usage in measures (TMDL)
        run: |
          echo "üîç Validating DAX measures for correct DIVIDE() usage..."
          MODEL_PATH="CCDP.SemanticModel/definition/model.tmdl"
          echo "üìÑ Checking for $MODEL_PATH..."
          if [ ! -f "$MODEL_PATH" ]; then
            echo "‚ùå Error: model.tmdl not found at $MODEL_PATH"
            exit 1
          fi
          chmod +r "$MODEL_PATH"

          # Find measures that use "/" instead of DIVIDE()
          INVALID_MEASURES=$(grep -E 'measure .*=' "$MODEL_PATH" 2>/dev/null | grep '/' || true)
          if [ ! -z "$INVALID_MEASURES" ]; then
            echo "‚ùå Found measures using '/' instead of DIVIDE():"
            echo "$INVALID_MEASURES"
            exit 1
          fi
          echo "‚úÖ All measures correctly use DIVIDE()."

      - name: Publish PBIP to Fabric Workspace
        env:
          WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
          FABRIC_TOKEN: ${{ env.FABRIC_TOKEN }}
        run: |
          echo "üöÄ Publishing CCDP.pbip to Fabric workspace $WORKSPACE_ID..."
          if [ ! -f "CCDP.pbip" ]; then
            echo "‚ùå Error: CCDP.pbip file not found in repo root!"
            exit 1
          fi
          curl -X POST \
            "${{ env.FABRIC_API_URL }}/v1/workspaces/$WORKSPACE_ID/files" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -F "file=@CCDP.pbip" \
            -F "overwrite=true" \
            -F "displayName=CCDP.pbip" \
            || { echo "‚ùå Error: Failed to publish CCDP.pbip"; exit 1; }
          echo "‚úÖ CCDP.pbip published successfully."
