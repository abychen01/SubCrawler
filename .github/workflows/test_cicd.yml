name: Power BI Fabric CI/CD (with BPA - TE3)

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [main]

env:
  FABRIC_API_URL: https://api.fabric.microsoft.com

permissions:
  id-token: write
  contents: read

jobs:
  validate-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Tabular Editor 3 Portable
        shell: pwsh
        run: |
          Write-Host "‚¨áÔ∏è  Downloading Tabular Editor 3 portable..."
          $url = "https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor3.Portable.zip"
          Invoke-WebRequest -Uri $url -OutFile "TabularEditor3.zip"
          Expand-Archive TabularEditor3.zip -DestinationPath "TabularEditor3"
          Write-Host "‚úÖ Tabular Editor 3 extracted."
          Get-ChildItem TabularEditor3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: >
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": ""
            }
          auth-type: SERVICE_PRINCIPAL
          allow-no-subscriptions: true

      - name: Get Fabric Access Token
        shell: pwsh
        run: |
          Write-Host "üîê Fetching Fabric access token..."
          $FABRIC_TOKEN = az account get-access-token --resource "${{ env.FABRIC_API_URL }}" --query accessToken -o tsv
          Write-Host "FABRIC_TOKEN=$FABRIC_TOKEN" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8
          Write-Host "‚úÖ Token retrieved."

      - name: Run BPA Validation (TE3)
        shell: pwsh
        run: |
          Write-Host "üîç Running Best Practice Analyzer (TE3)..."

          $ModelPath = "CCDP.SemanticModel/definition/model.tmdl"
          $RulesPath = "BPARules.json"
          $TEPath = "TabularEditor3/TabularEditor.exe"
          $ExportPath = Join-Path (Get-Location) "bpa-results.json"

          Write-Host "Working directory: $(Get-Location)"
          Write-Host "Model path: $ModelPath"
          Write-Host "Rules path: $RulesPath"
          Write-Host "Export path: $ExportPath"

          if (-Not (Test-Path $ModelPath)) { Write-Error "‚ùå model.tmdl not found"; exit 1 }
          if (-Not (Test-Path $RulesPath)) { Write-Error "‚ùå BPARules.json not found"; exit 1 }

          # Run BPA
          Write-Host "üß† Executing BPA via TE3..."
          & $TEPath -BPA $ModelPath -Rules $RulesPath -ExportResults $ExportPath -Format JSON

          if (-Not (Test-Path $ExportPath)) { Write-Error "‚ùå BPA export file not created"; exit 1 }

          $results = Get-Content $ExportPath | ConvertFrom-Json
          $violations = $results | Where-Object { $_.Severity -eq "Error" -or $_.Severity -eq "Warning" }

          if ($violations.Count -gt 0) {
              Write-Host "‚ùå BPA found $($violations.Count) issues:"
              $violations | ForEach-Object { Write-Host " - Rule: $($_.RuleId) | $($_.Message)" }
              exit 1
          } else {
              Write-Host "‚úÖ BPA validation passed."
          }

      - name: Publish PBIP to Fabric Workspace
        if: success()
        shell: pwsh
        env:
          WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
          FABRIC_TOKEN: ${{ env.FABRIC_TOKEN }}
        run: |
          Write-Host "üöÄ Publishing CCDP.pbip to Fabric workspace $WORKSPACE_ID..."
          if (-Not (Test-Path "CCDP.pbip")) {
              Write-Error "‚ùå CCDP.pbip not found!"
              exit 1
          }

          $Response = curl -s -w "`n%{http_code}" -X POST `
            "${{ env.FABRIC_API_URL }}/v1/workspaces/$WORKSPACE_ID/files" `
            -H "Authorization: Bearer $FABRIC_TOKEN" `
            -F "file=@CCDP.pbip" `
            -F "overwrite=true" `
            -F "displayName=CCDP.pbip"

          $HTTP_BODY = $Response -split "`n" | Select-Object -First ($Response.Length - 1)
          $HTTP_CODE = $Response -split "`n" | Select-Object -Last 1
          Write-Host "Response code: $HTTP_CODE"
          Write-Host "Response body: $HTTP_BODY"

          if ([int]$HTTP_CODE -ge 200 -and [int]$HTTP_CODE -lt 300) {
              Write-Host "‚úÖ CCDP.pbip published successfully."
          } else {
              Write-Error "‚ùå Publish failed with HTTP $HTTP_CODE"
              exit 1
          }
