name: deploy

on:
  push:
    branches:
      - feature/CD

env:
  FABRIC_WORKSPACE_ID: ${{ vars.DEV_WORKSPACE_ID }}
  FABRIC_XMLA_ENDPOINT: ${{ vars.FABRIC_XMLA_ENDPOINT }}

jobs:
  deploy:
    name: Deploy to Microsoft Fabric
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout latest code
      - name: Check out the code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # 3Ô∏è‚É£ Install Microsoft Fabric CLI
      - name: Install Fabric CLI
        run: |
          python -m pip install --upgrade pip
          pip install ms-fabric-cli

      # 4Ô∏è‚É£ Authenticate to Microsoft Fabric
      - name: Authenticate to Microsoft Fabric
        env:
          FABRIC_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          fabric login --service-principal \
            --client-id $FABRIC_CLIENT_ID \
            --client-secret $FABRIC_CLIENT_SECRET \
            --tenant-id $FABRIC_TENANT_ID

      # 5Ô∏è‚É£ Deploy PBIP, Semantic Model, and Report to Fabric Workspace
      - name: Deploy to Fabric Workspace
        run: |
          echo "üöÄ Deploying CCDP assets to Microsoft Fabric workspace..."
          fabric workspace select $FABRIC_WORKSPACE_ID

          echo "‚û°Ô∏è Deploying CCDP.pbip"
          fabric item deploy CCDP.pbip --workspace $FABRIC_WORKSPACE_ID --overwrite

          echo "‚û°Ô∏è Deploying CCDP.SemanticModel"
          fabric item deploy CCDP.SemanticModel --workspace $FABRIC_WORKSPACE_ID --overwrite

          echo "‚û°Ô∏è Deploying CCDP.Report"
          fabric item deploy CCDP.Report --workspace $FABRIC_WORKSPACE_ID --overwrite

      # 6Ô∏è‚É£ Verify deployment
      - name: Verify Deployed Items
        run: |
          echo "‚úÖ Deployment complete! Listing items in workspace..."
          fabric item list --workspace $FABRIC_WORKSPACE_ID